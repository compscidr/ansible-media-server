---
- name: Create Transmission Directories
  tags: transmission
  become: true
  ansible.builtin.file:
    path: "{{ transmission_folder }}"
    state: directory
    mode: "755"
    owner: root
    group: root

- name: Create default transmission .env file
  tags: transmission
  become: true
  ansible.builtin.copy:
    content: |
      # Transmission environment variables
      # Add your OpenVPN credentials and configuration here
    dest: "{{ transmission_env_file }}"
    mode: "600"
    force: false
  when: lookup('env', 'CI') != 'true'

- name: Create CI transmission .env file with VPN credentials
  tags: transmission
  become: true
  ansible.builtin.copy:
    content: |
      OPENVPN_PROVIDER={{ lookup('env', 'OPENVPN_PROVIDER') | default('NORDVPN') }}
      OPENVPN_USERNAME={{ lookup('env', 'OPENVPN_USERNAME') | default('') }}
      OPENVPN_PASSWORD={{ lookup('env', 'OPENVPN_PASSWORD') | default('') }}
      NORDVPN_PROTOCOL={{ lookup('env', 'NORDVPN_PROTOCOL') | default('udp') }}
      NORDVPN_CATEGORY={{ lookup('env', 'NORDVPN_CATEGORY') | default('legacy_p2p') }}
      NORDVPN_COUNTRY={{ lookup('env', 'NORDVPN_COUNTRY') | default('United States') }}
      LOCAL_NETWORK=172.0.0.0/8
      TRANSMISSION_SCRAPE_PAUSED_TORRENTS=false
      TRANSMISSION_RATIO_LIMIT=0
      TRANSMISSION_RATIO_LIMIT_ENABLED=true
    dest: "{{ transmission_env_file }}"
    mode: "600"
  when: lookup('env', 'CI') == 'true'

- name: Deploy transmission
  tags: transmission
  become: true
  community.docker.docker_container:
    name: transmission
    image: haugene/transmission-openvpn:latest
    pull: true
    ports:
      - "{{ transmission_port }}:9091"
    restart_policy: unless-stopped
    devices:
      - /dev/net/tun
    capabilities:
      - NET_ADMIN
    volumes:
      - "{{ transmission_downloads_folder }}:/data"
      - "{{ transmission_folder }}:/config"
    env:
      TZ: "{{ transmission_tz }}"
      PUID: "{{ transmission_pid }}"
      PGID: "{{ transmission_gid }}"
    env_file: "{{ transmission_env_file }}"
    memory: "{{ transmission_memory }}"
    memory_swap: "{{ transmission_memory_swap }}"
